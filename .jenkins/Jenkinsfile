pipeline {
    agent any
      environment {
        // vist this https://www.jenkins.io/doc/book/pipeline/syntax/#environment
        REGISTRY_CREDS=credentials('dockerhub-mahdi-magroun')
    }
    stages {
        stage('Preparation') {
           
               agent{
                docker{
                    image 'composer:latest'
                    args """
                    -v ./:/app
                    -w /app
                    -e  APP_ENV=prod 
                    -e db_user=${env.blog_db_user_prod} \
                    -e  db_pwd=${env.blog_db_password_prod} \
                    -e db_host=${env.blog_host} \
                    -e db_port=${env.blog_port} \
                    -e db=${env.blog_dbname_prod} \
                    """
                    reuseNode true
                }
            }
             steps {
                    echo "Preparing code .... "
                    sh '''
                    env
                        composer install --no-interaction --no-dev --optimize-autoloader 
                 
                     ''' 
                     //        APP_ENV=prod APP_DEBUG=0 php bin/console cache:clear
            }
        }
        stage('Build') {
             
            steps {
                 echo "Building ... "
                
                 script {
                   if(env.BRANCH_NAME == 'main'){
                   sh '''docker build  --build-arg APP_ENV=prod \
                        --build-arg db_user=${blog_db_user_prod} \
                          --build-arg db_pwd=${blog_db_password_prod} \
                        --build-arg db_host=${blog_host} \
                           --build-arg db_port=${blog_port} \
                        --build-arg db=${blog_dbname_prod} \
                     -t mahdi0188/symfony-blog:latest .
                     '''


                   }
                   else{
                    sh """docker build  -e APP_ENV=test \
                        -e db_user=${env.blog_db_user_dev} \
                          -e db_pwd=${env.blog_db_password_dev} \
                        -e db_host=${env.blog_host} \
                          -e db_port=${env.blog_port} \
                       -e db=${env.blog_dbname_dev} \
                     -t mahdi0188/symfony-blog:latest .
                     """

                   }

                 }
            }
        }
          stage('Testing') {
            agent{
              docker{
                    image 'mahdi0188/symfony-blog:latest'
                    args '''
                    -w /var/www/html/back-end
                    '''

                    reuseNode true
                }
            }
            steps {
                 echo "Testing ... "
                 // sh "php bin/phpunit":: need some investment 
                   
            }
        }
        stage('Database Migrations') {
            agent{
              docker{
                    image 'mahdi0188/symfony-blog:latest'
                    args '''
                    -w /var/www/html/back-end
                    '''

                    reuseNode true
                }
            }
            steps {
                 echo "Migrating ... "
                 sh "php bin/console doctrine: schema: update â€“force"
                 sh "php bin/console doctrine:migrations:migrate"

            }
        }
         stage('Pushing To Registry ') {
             
            steps {
                 echo "Pushing ... "
                  sh 'docker login -u $REGISTRY_CREDS_USR -p $REGISTRY_CREDS_PSW'
                  sh "docker push mahdi0188/symfony-blog:latest"
                   
            }
        }

        stage('Deploy Dev') {
            when {
                branch "develop"
            }
            steps {
                 echo "deploying into development envirement  ... "
               /**
               * connect to docker container 
               * 
               */
            }
        }

         stage('Deploy Prod') {
              when {
                branch "main"
            }
            steps {
                echo "deploying into production envirement  ... "
                 // here do not forget to lanch database migrations
            }
        }
    }
}
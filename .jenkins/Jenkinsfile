pipeline {
    agent any
      environment {
        // vist this https://www.jenkins.io/doc/book/pipeline/syntax/#environment
        REGISTRY_CREDS=credentials('dockerhub-mahdi-magroun')
    }
    stages {
        stage('Preparation') {
           
               agent{
                docker{
                    image 'composer:latest'
                    args '''
                    -v ./:/app
                    -w /app
                    '''
                    reuseNode true
                }
            }
             steps {
                    echo "Preparing code .... "
                    sh '''
                        composer install --no-interaction --no-dev --optimize-autoloader  
                 
                     ''' 
                     //        APP_ENV=prod APP_DEBUG=0 php bin/console cache:clear
            }
        }
        stage('Build') {
             
            steps {
                 echo "Building ... "
                
                 script {
                   if(env.BRANCH_NAME == 'main'){
                  sh "docker build  --build_arg APP_ENV=prod -t mahdi0188/symfony-blog:latest ."

                   }
                   else{
                    sh "docker build  --build_arg APP_ENV=test -t mahdi0188/symfony-blog:latest ."

                   }
                 }
            }
        }
          stage('Testing') {
            agent{
              docker{
                    image 'mahdi0188/symfony-blog:latest'
                    args '''
                    -w /var/www/html/back-end
                    '''

                    reuseNode true
                }
            }
            steps {
                 echo "Testing ... "
                 // sh "php bin/phpunit":: need some investment 
                   
            }
        }
         stage('Pushing To Registry ') {
             
            steps {
                 echo "Pushing ... "
                  sh 'docker login -u $REGISTRY_CREDS_USR -p $REGISTRY_CREDS_PSW'
                  sh "docker push mahdi0188/symfony-blog:latest"
                   
            }
        }

        stage('Deploy Dev') {
            when {
                branch "develop"
            }
            steps {
                 echo "deploying into development envirement  ... "
                 // here do not forget to lanch database migrations
            }
        }

         stage('Deploy Prod') {
              when {
                branch "main"
            }
            steps {
                echo "deploying into production envirement  ... "
                 // here do not forget to lanch database migrations
            }
        }
    }
}